# PoweshellArtifactDemo

## Preperation

we need to preapre the AzureDevops Environment and collect some information before beginning.

- PatToken: Personal Access Token is a key generated by AzureDevops per Organisation to access features of AzureDevops. We need this to acess to the feed.
- FeedLocation: We need to create a feed in Artifacts of Azure Devops and populate the URI.
- Nuget.exe: This is used for packaging Powershell Module into a NuGet Package to be hosted in the Artifact Feed. Free download avaiable. 

Once the preparations are done we can set our variaables in the beggining of the Demo.ps1 like follows.

```PowerShell
$NugetFolder = 'C:\Temp'
$LocalRepo = 'C:\Repos\PSModulesv2'
$patToken = 'izltzcaslejgm3wt272c4ijztr2dpeyokocpfbthehofb2dkuxjq'
$FeedName = 'PowerShellModules1'
$FeedLocation = "https://pkgs.dev.azure.com/emrgcl/PSModulesv2/_packaging/$FeedName/nuget"
$ModuleName = 'ArtifactDemo'
```

## Prepare the Nuget Package

1. Download Nuget nuget exe from https://www.nuget.org/downloads to c:\temp

    ```PowerShell
    $sourceNugetExe = "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe"
    $targetNugetExe = "$NugetFolder\nuget.exe"
    Invoke-WebRequest $sourceNugetExe -OutFile $targetNugetExe
    ```

1. Set the version in Get-help.psd1  ModuleVersion to 1.0.x (3 digits) to be used in nuget package
    ```PowerShell
    psedit "$LocalRepo\$ModuleName\$ModuleName.psd1"
    ```

1. CD into working folder which is the module folder
    ```PowerShell
    Cd "$LocalRepo\$ModuleName"
    gci
    ```

1. Create the nuspec file
    ```PowerShell
    invoke-expression "$NugetFolder\nuget.exe spec $ModuleName -Force"
    gci 
    ```

1. Edit the nuspec file, 
    - Version should match with the one in psd1 file, 
    - Remove the sample dependencies within ```<Dependencies>```
    
    ```PowerShell
    psedit "$LocalRepo\$ModuleName\$ModuleName.nuspec"
    ```    
   
1. Pack the files using nuget file Get-Hello.nuspec

    ```PowerShell
    invoke-expression "$NugetFolder\nuget.exe pack $ModuleName.nuspec"
    ```

1. Move the Package to Packages folder (lets be tidy!)
    ```PowerShell
    Move-Item -Path "$LocalRepo\$ModuleName\*.nupkg" -Destination "$LocalRepo\packages"
    Get-ChildItem -Path "$LocalRepo\Packages"
    ```
1. Add the Azure Devops Services Repo as a source for Nuget
    ```PowerShell
    c:\temp\nuget.exe sources Add -Name $FeedName -Source "$($FeedLocation)/v3/index.json" -username "emreg@microsoft.com" -password $patToken
    invoke-expression "$NugetFolder\nuget.exe push -Source $FeedName -ApiKey AZ $LocalRepo\Packages\$ModuleName.1.0.5.nupkg"
    ```

## Register to Repository

1. Create Credential
    ```PowerShell
    $patTokenCred = $patToken | ConvertTo-SecureString -AsPlainText -Force 
    $credsAzureDevopsServices = New-Object System.Management.Automation.PSCredential("emreg@microsoft.com", $patTokenCred)
    ```
1. Register to repository
    ```PowerShell
    Get-PSRepository | ft -AutoSize
    Register-PSRepository -Name "PowershellAzureDevopsServices" -SourceLocation "$($FeedLocation)/v2"  -PublishLocation "$($FeedLocation)/v2" -InstallationPolicy Trusted -Credential $credsAzureDevopsServices
    ```
1. Verify the repository
    ```PowerShell
    Get-PSRepository | ft -AutoSize
    ```
1. lets see powershell modules folder
    ```PowerShell
    gci -path (($Env:PSModulePath -split ';')[1]) | ? Name -eq $ModuleName
    ```
1. Lets see if the module sits in our repo :) 
    ```PowerShell
    Find-Module -Repository PowershellAzureDevopsServices -Credential $credsAzureDevopsServices
    ```

# Install Module  and use
1. Install Module
    ```PowerShell
    Install-Module -Name $ModuleName -Repository PowershellAzureDevopsServices -Credential $credsAzureDevopsServices
    ```
1. lets see powershell modules folder
    ```PowerShell
    gci -path (($Env:PSModulePath -split ';')[1]) | ? Name -eq $ModuleName
    ```
1. ImportModule and run
    ```PowerShell
    Import-Module ArtifactDemo
    Get-Hello
    ```

# References
 - [Use NuGet with Azure DevOps Services feeds](https://docs.microsoft.com/en-us/azure/devops/artifacts/nuget/nuget-exe?view=azure-devops#add-a-feed-to-nuget-2)
 - [Use Azure Artifacts as a private PowerShell repository](https://docs.microsoft.com/en-us/azure/devops/artifacts/tutorials/private-powershell-library?view=azure-devops)
 - [Download Nuget.Exe](https://www.nuget.org/downloads)
 
